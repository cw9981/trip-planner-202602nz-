<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>202602 NZ æ—…è¡Œå”ä½œç«™</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 900px; margin: auto; line-height: 1.6; }
    h1, h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 15px 0; }
    th, td { border: 1px solid #aaa; padding: 10px; text-align: center; }
    input[type="text"] { width: 100%; padding: 6px; box-sizing: border-box; }
    input[type="checkbox"] { transform: scale(1.3); }
    button { padding: 10px 20px; font-size: 16px; margin: 10px 5px; cursor: pointer; }
    .confirmed { background-color: #e6f4ea; }
    .todo-item { display: flex; align-items: center; margin: 8px 0; }
    #new-todo { padding: 8px; width: 70%; }
  </style>
</head>
<body>

<h1>âœˆï¸ 202602 NZ æ—…è¡Œå”ä½œç«™</h1>

<label style="display:block; margin:15px 0;">
  æˆ‘æ˜¯ï¼š
  <select id="person" onchange="reloadViews()">
    <option value="Alice">Alice</option>
    <option value="Bob">Bob</option>
    <option value="Carol">Carol</option>
  </select>
</label>

<!-- è¡Œç¨‹å€ -->
<h2>ğŸ“… æ¯æ—¥è¡Œç¨‹ï¼ˆç¬¬ 1ï½22 å¤©ï¼‰</h2>
<table id="itinerary-table">
  <thead><tr><th>ç¬¬å¹¾å¤©</th><th>æƒ³å»å“ªè£¡ï¼Ÿ</th><th>ç¢ºèªè¡Œç¨‹ï¼Ÿ</th></tr></thead>
  <tbody id="itinerary-body"></tbody>
</table>
<button onclick="saveItinerary()">ğŸ’¾ å„²å­˜è¡Œç¨‹</button>

<!-- å¾…è¾¦æ¸…å–® -->
<h2>âœ… æˆ‘çš„è¡Œæèˆ‡å¾…è¾¦äº‹é …</h2>
<div id="todo-list"></div>
<input type="text" id="new-todo" placeholder="è¼¸å…¥è¦å¸¶çš„æ±è¥¿æˆ–å¾…è¾¦..." />
<button onclick="addTodo()">â• æ–°å¢</button>
<button onclick="saveTodos()">ğŸ’¾ å„²å­˜å¾…è¾¦</button>

<script>
  // ğŸ”§ æ›¿æ›æˆä½ çš„ Google Apps Script Web App URLï¼
  const API_URL = "https://script.google.com/macros/s/YOUR_DEPLOY_ID/exec";

  let itineraryData = [];
  let todosData = [];

  function PERSON() {
    return document.getElementById("person").value;
  }

  // åˆå§‹åŒ–
  window.onload = async () => {
    await loadAllData();
    reloadViews();
  };

  async function loadAllData() {
    try {
      const res1 = await fetch(`${API_URL}?action=getItinerary`);
      itineraryData = await res1.json();
      
      const res2 = await fetch(`${API_URL}?action=getTodos`);
      todosData = await res2.json();
    } catch (e) {
      alert("âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª API_URL æ˜¯å¦æ­£ç¢ºï¼");
      console.error(e);
    }
  }

  function reloadViews() {
    renderItinerary();
    renderTodos();
  }

  function renderItinerary() {
    const tbody = document.getElementById("itinerary-body");
    tbody.innerHTML = "";
    for (let day = 1; day <= 22; day++) {
      const myRecord = itineraryData.find(r => r[0] == day && r[1] === PERSON());
      const activity = myRecord ? (r => r[2] || "")(myRecord) : "";
      const confirmed = myRecord ? (r => r[3] === true || r[3] === "TRUE")(myRecord) : false;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${day}</td>
        <td><input type="text" data-day="${day}" value="${activity}"></td>
        <td><input type="checkbox" ${confirmed ? "checked" : ""} data-day="${day}"></td>
      `;
      if (confirmed) row.classList.add("confirmed");
      tbody.appendChild(row);
    }
  }

  function renderTodos() {
    const container = document.getElementById("todo-list");
    container.innerHTML = "";
    const myTodos = todosData.filter(r => r[0] === PERSON());
    myTodos.forEach((row, i) => {
      const div = document.createElement("div");
      div.className = "todo-item";
      const completed = row[2] === true || row[2] === "TRUE";
      div.innerHTML = `
        <input type="checkbox" ${completed ? "checked" : ""} data-index="${i}">
        <span>${row[1]}</span>
      `;
      container.appendChild(div);
    });
  }

  async function saveItinerary() {
    const inputs = document.querySelectorAll("#itinerary-body input[type='text']");
    const checks = document.querySelectorAll("#itinerary-body input[type='checkbox']");

    const newData = itineraryData.filter(r => r[1] !== PERSON());
    inputs.forEach((input, i) => {
      const day = input.dataset.day;
      const activity = input.value.trim();
      const confirmed = checks[i].checked;
      if (activity || confirmed) {
        newData.push([parseInt(day), PERSON(), activity, confirmed]);
      }
    });
    newData.sort((a, b) => a[0] - b[0]);

    try {
      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          person: PERSON(),
          type: "updateItinerary",
          data: [["day", "person", "activity", "confirmed"], ...newData]
        })
      });
      alert("âœ… è¡Œç¨‹å·²å„²å­˜ï¼");
    } catch (e) {
      alert("âŒ å„²å­˜å¤±æ•—ï¼š" + e.message);
    }
  }

  async function saveTodos() {
    const checkboxes = document.querySelectorAll("#todo-list .todo-item input[type='checkbox']");
    const texts = Array.from(document.querySelectorAll("#todo-list .todo-item span")).map(el => el.innerText);

    const newData = todosData.filter(r => r[0] !== PERSON());
    texts.forEach((text, i) => {
      const completed = checkboxes[i].checked;
      newData.push([PERSON(), text, completed]);
    });

    try {
      await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          person: PERSON(),
          type: "updateTodos",
          data: [["person", "item", "completed"], ...newData]
        })
      });
      alert("âœ… å¾…è¾¦å·²å„²å­˜ï¼");
    } catch (e) {
      alert("âŒ å„²å­˜å¤±æ•—ï¼š" + e.message);
    }
  }

  function addTodo() {
    const input = document.getElementById("new-todo");
    const text = input.value.trim();
    if (!text) return;
    todosData.push([PERSON(), text, false]);
    renderTodos();
    input.value = "";
  }
</script>

</body>
</html>